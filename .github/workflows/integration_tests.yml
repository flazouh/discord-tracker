name: Test consuming this action
on:
  pull_request:
    branches: [v1]
  workflow_run:
    workflows: ["Docker Publish"]
    branches: [v1]
    types:
      - completed

jobs:
  test_init:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - id: test
        uses: ./
        with:
          action: 'init'
          pr_number: '123'
          pr_title: 'Test PR'
          author: 'testuser'
          repository: 'test/repo'
          branch: 'main'
          discord_bot_token: ${{ secrets.DISCORD_BOT_TOKEN }}
          discord_channel_id: ${{ secrets.DISCORD_CHANNEL_ID }}
      - name: Verify success
        if: steps.test.outputs.success == 'true'
        run: echo "Action completed successfully"

  test_step:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - id: test
        uses: ./
        with:
          action: 'step'
          step_number: '1'
          total_steps: '3'
          step_name: 'Build'
          status: 'success'
          additional_info: '{"duration":"30s","artifacts":"build.zip"}'
          discord_bot_token: ${{ secrets.DISCORD_BOT_TOKEN }}
          discord_channel_id: ${{ secrets.DISCORD_CHANNEL_ID }}
      - name: Verify success
        if: steps.test.outputs.success == 'true'
        run: echo "Step action completed successfully"

  test_complete:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - id: test
        uses: ./
        with:
          action: 'complete'
          discord_bot_token: ${{ secrets.DISCORD_BOT_TOKEN }}
          discord_channel_id: ${{ secrets.DISCORD_CHANNEL_ID }}
      - name: Verify success
        if: steps.test.outputs.success == 'true'
        run: echo "Complete action finished successfully"

  test_fail:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - id: test
        continue-on-error: true
        uses: ./
        with:
          action: 'fail'
          step_name: 'Test'
          error_message: 'This is a test error'
          discord_bot_token: ${{ secrets.DISCORD_BOT_TOKEN }}
          discord_channel_id: ${{ secrets.DISCORD_CHANNEL_ID }}
      - name: Verify failure
        if: steps.test.outputs.error != ''
        run: 'echo "Failed as expected with error: ${{ steps.test.outputs.error }}"'
      - name: Unexpected success
        if: steps.test.outputs.error == ''
        run: echo "Succeeded unexpectedly" && exit 1

  test_invalid_action:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - id: test
        continue-on-error: true
        uses: ./
        with:
          action: 'invalid_action'
          discord_bot_token: ${{ secrets.DISCORD_BOT_TOKEN }}
          discord_channel_id: ${{ secrets.DISCORD_CHANNEL_ID }}
      - name: Verify error
        if: steps.test.outputs.error != ''
        run: 'echo "Error handled correctly: ${{ steps.test.outputs.error }}"'
      - name: Unexpected success
        if: steps.test.outputs.error == ''
        run: echo "Should have failed with invalid action" && exit 1 